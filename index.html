<!doctype html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>編集距離と差分計算</title>
		<style>
			html {
				min-height: 100dvh;
			}
			html.loading,
			html.loading * {
				cursor: wait !important;
			}
			body {
				font-family: sans-serif;
				margin: 2em;
				background-color: #f4f4f4;
				color: #333;
			}
			h1 {
				color: #0056b3;
				text-align: center;
				margin-bottom: 1.5em;
			}
			form {
				background-color: #fff;
				padding: 2.5em;
				border-radius: 8px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
				max-width: 900px;
				margin: 2em auto;
			}
			.form-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 20px;
			}
			.form-group {
				display: flex;
				flex-direction: column;
			}
			label {
				display: block;
				margin-bottom: 0.6em;
				font-weight: bold;
				color: #555;
			}
			textarea {
				width: calc(100% - 20px);
				padding: 10px;
				margin-bottom: 1.2em;
				border: 1px solid #ddd;
				border-radius: 4px;
				resize: vertical;
				min-height: 150px;
				font-size: 1em;
				line-height: 1.5;
			}
			button {
				display: block;
				width: 100%;
				padding: 1em;
				background-color: #007bff;
				color: white;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				font-size: 1.1em;
				font-weight: bold;
				transition: background-color 0.3s ease;
				grid-column: 1 / -1;
			}
			button:disabled {
				background-color: #607ba0;
				cursor: not-allowed;
			}
			button:hover:not(button:disabled) {
				background-color: #0056b3;
			}
			.result-container {
				max-width: 900px;
				margin: 2em auto;
				background-color: #fff;
				padding: 2.5em;
				border-radius: 8px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			}
			.result-box {
				background-color: #e9f7ef;
				border: 1px solid #c3e6cb;
				padding: 1.5em;
				border-radius: 8px;
				margin-bottom: 1.5em;
			}
			.result-box h2 {
				color: #28a745;
				margin-top: 0;
			}
			.result-box p {
				margin-bottom: 0.5em;
			}
			.error-message {
				background-color: #ffe6e6;
				border: 1px solid #ff0000;
				color: #ff0000;
				padding: 1em;
				border-radius: 8px;
				margin-top: 2em;
				text-align: center;
				font-weight: bold;
			}

			.diff-section h2 {
				color: #0056b3;
				margin-top: 1.5em;
			}
			.diff-flex-container {
				display: flex;
				gap: 20px;
				margin-top: 1em;
			}
			.diff-pane {
				flex: 1;
				background-color: #f9f9f9;
				border: 1px solid #ddd;
				border-radius: 4px;
				padding: 1em;
			}
			.diff-pane h3 {
				margin-top: 0;
				color: #555;
				font-size: 1.1em;
				border-bottom: 1px solid #eee;
				padding-bottom: 0.5em;
				margin-bottom: 1em;
			}
			.diff-output {
				white-space: pre-wrap;
				word-wrap: break-word;
				font-family: monospace;
				font-size: 0.9em;
				min-height: 150px;
				max-height: 400px;
				overflow-y: auto;
				padding: 0.5em;
			}
			.diff-removed {
				background-color: #ffad99;
				color: #333;
			}
			.diff-added {
				background-color: #99ff99;
				color: #333;
			}
			progress {
				width: 100%;
				height: 8px;
				-webkit-appearance: none;
				appearance: none;
				border: 1px solid #c0c8cf;
				background-color: #e0e8ef;
			}

			progress::-webkit-progress-bar {
				background-color: #e0e8ef;
			}

			progress::-webkit-progress-value {
				background-color: #007bff;
			}

			progress::-moz-progress-bar {
				background-color: #007bff;
			}
			.indeterminate-progress-bar {
				width: 100%;
				height: 8px;
				background-color: #e0e8ef;
				position: relative;
				overflow: hidden;
				border: 1px solid #c0c8cf;
				color: transparent;
			}

			.indeterminate-progress-bar::before {
				content: "";
				position: absolute;
				top: 0;
				left: -100%;
				width: 33%;
				height: 100%;
				background-color: #007bff;
				animation: indeterminate-animation 1.5s infinite linear;
			}

			@keyframes indeterminate-animation {
				0% {
					left: -33%;
				}
				100% {
					left: 100%;
				}
			}
		</style>
	</head>
	<body>
		<h1>編集距離と差分計算</h1>

		<form id="diffForm">
			<div class="form-grid">
				<div class="form-group">
					<label for="text1">テキスト1:</label>
					<textarea
						id="text1"
						name="text1"
						rows="5"
						required
						placeholder="最初のテキストを入力してください。"
					></textarea>
				</div>
				<div class="form-group">
					<label for="text2">テキスト2:</label>
					<textarea
						id="text2"
						name="text2"
						rows="5"
						required
						placeholder="比較するテキストを入力してください。"
					></textarea>
				</div>
			</div>
			<button type="submit" id="submitButton">計算と差分表示</button>
		</form>

		<div id="resultsContainer"></div>
		<script>
			function escapeHtml(text) {
				const map = {
					"&": "&amp;",
					"<": "&lt;",
					">": "&gt;",
					'"': "&quot;",
					"'": "&#039;",
				};
				return text.replace(/[&<>"']/g, function (m) {
					return map[m];
				});
			}

			function callWorker(text1, text2) {
				const worker = new Worker("worker.js");
				worker.postMessage({ text1, text2 });
				return new Promise((resolve) => {
					worker.onmessage = function (e) {
						if (e.data.type === "progress") {
							document.getElementById("resultsContainer").innerHTML =
								`<div class="result-container"><progress value="${e.data.value}">${e.data.text}</progress></div>`;
						} else if (e.data.type === "result") {
							resolve([e.data.distance, e.data.html1, e.data.html2]);
						}
					};
				});
			}

			function updateResultsDisplay(
				charDist,
				diffHtml1,
				diffHtml2,
				calculationTimeMs,
				error,
			) {
				const resultsContainer = document.getElementById("resultsContainer");
				let content = "";

				if (error) {
					content = `<div class="error-message">${escapeHtml(error)}</div>`;
				} else {
					content = `
                    <div class="result-container">
                        <div class="result-box">
                            <h2>計算結果</h2>
                            <p><strong>文字ベースの編集距離:</strong> ${charDist !== null ? charDist : "計算できませんでした"}</p>
                            <p><strong>計算時間:</strong> ${calculationTimeMs !== null && calculationTimeMs !== undefined ? calculationTimeMs.toFixed(2) + " ms" : "---"}</p>
                        </div>
                        <div class="diff-section">
                            <h2>差分表示</h2>
                            <div class="diff-flex-container">
                                <div class="diff-pane">
                                    <h3>テキスト1</h3>
                                    <pre class="diff-output">${diffHtml1 || ""}</pre>
                                </div>
                                <div class="diff-pane">
                                    <h3>テキスト2</h3>
                                    <pre class="diff-output">${diffHtml2 || ""}</pre>
                                </div>
                            </div>
                            <p class="diff-legend">
                                <span class="diff-changed-legend">■ 変更</span>
                                <span class="diff-removed-legend">■ 削除</span>
                                <span class="diff-added-legend">■ 追加</span>
                            </p>
                        </div>
                    </div>
                `;
				}
				resultsContainer.innerHTML = content;
			}

			document
				.getElementById("diffForm")
				.addEventListener("submit", async function (event) {
					event.preventDefault();

					const form = event.target;
					const text1 = form.text1.value;
					const text2 = form.text2.value;

					const submitButton = document.getElementById("submitButton");

					submitButton.disabled = true;
					document.getElementById("resultsContainer").innerHTML =
						`<div class="result-container"><div class="indeterminate-progress-bar">準備中...</div></div>`;
					document.documentElement.classList.add("loading");

					let charDist = null;
					let diffHtml1 = "";
					let diffHtml2 = "";
					let calculationTimeMs = null;
					let error = null;

					try {
						const startTime = performance.now();

						[charDist, diffHtml1, diffHtml2] = await callWorker(text1, text2);

						const endTime = performance.now();
						calculationTimeMs = endTime - startTime;
					} catch (e) {
						console.error("Calculation error:", e);
						if (e instanceof Error) {
							error = `計算中にエラーが発生しました: ${e.message}`;
						} else {
							error = `計算中に不明なエラーが発生しました: ${e}`;
						}
					} finally {
						updateResultsDisplay(
							charDist,
							diffHtml1,
							diffHtml2,
							calculationTimeMs,
							error,
						);
						document.documentElement.classList.remove("loading");

						submitButton.disabled = false;
					}
				});
		</script>
	</body>
</html>
